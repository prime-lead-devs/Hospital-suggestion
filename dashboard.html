<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Manager Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin:20px; background:#f8f9fa; color:#111; }
    h1 { color:#0a7b3f; text-align:center; }
    .card { background:#fff; padding:20px; border-radius:10px; max-width:900px; margin:20px auto; box-shadow:0 6px 20px rgba(0,0,0,0.06); }
    table { width:100%; border-collapse:collapse; margin-top:20px; }
    th, td { padding:10px; border:1px solid #ccc; text-align:left; }
    th { background:#eee; }
    button { padding:6px 10px; border:none; border-radius:5px; cursor:pointer; background:#0b5ed7; color:#fff; }
    #loginForm { max-width:400px; margin:50px auto; }
    input { width:100%; padding:10px; margin:6px 0; border-radius:5px; border:1px solid #ccc; }
    .logout { float:right; background:#d9534f; }
    .small { font-size:0.9rem; color:#666; }
    .answers-list { margin-top:10px; }
    .answer { padding:10px; border-bottom:1px solid #eee; }
    .meta { font-size:0.85rem; color:#666; margin-bottom:6px; }
    .back { margin-top:12px; background:#6c757d; }
    .empty { color:#666; padding:10px; }
  </style>
</head>
<body>

<div id="loginContainer" class="card">
  <h1>Manager Login</h1>
  <form id="loginForm">
    <label class="small" for="email">Email</label>
    <input type="email" id="email" placeholder="Email" required>
    <label class="small" for="password">Password</label>
    <input type="password" id="password" placeholder="Password" required>
    <button type="submit">Login</button>
    <p id="loginError" style="color:red;"></p>
  </form>
</div>

<div id="dashboardContainer" class="card" style="display:none;">
  <h1>Manager Dashboard</h1>
  <button id="logoutBtn" class="logout">Logout</button>
  <table>
    <thead>
      <tr>
        <th>Hospital Name</th>
        <th>Total Feedbacks</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="dashboardBody"></tbody>
  </table>
  <p id="noDataMessage" class="small" style="display:none;">No feedbacks found.</p>
</div>

<div id="answersContainer" class="card" style="display:none;">
  <h1 id="answersTitle">Answers</h1>
  <div id="answersList" class="answers-list"></div>
  <div style="text-align:right;">
    <button id="backBtn" class="back">Back to Dashboard</button>
  </div>
</div>

<script type="module">
document.addEventListener("DOMContentLoaded", () => {
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyDvVUrCLZj3Afu5MFqu5EhOGejyTfqEjgY",
    authDomain: "suggestion-box-4b869.firebaseapp.com",
    projectId: "suggestion-box-4b869",
    storageBucket: "suggestion-box-4b869.firebasestorage.app",
    messagingSenderId: "263926556991",
    appId: "1:263926556991:web:8c1f585f1f42fb72664b8a",
    measurementId: "G-RHHQJE2Y6B"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // DOM elements
  const loginContainer = document.getElementById("loginContainer");
  const dashboardContainer = document.getElementById("dashboardContainer");
  const answersContainer = document.getElementById("answersContainer");
  const loginForm = document.getElementById("loginForm");
  const loginError = document.getElementById("loginError");
  const dashboardBody = document.getElementById("dashboardBody");
  const logoutBtn = document.getElementById("logoutBtn");
  const noDataMessage = document.getElementById("noDataMessage");
  const answersTitle = document.getElementById("answersTitle");
  const answersList = document.getElementById("answersList");
  const backBtn = document.getElementById("backBtn");

  const HOSPITALS = [
    "The Matuu Hospital",
    "Reliable Healthcare Services Hospital",
    "Ekalakala Nursing Home",
    "Ultrakathiani Hospital",
    "Ultrakathiani Hospital- Mitaboni",
    "Namanga Nursing Home",
    "Ginger Hospital",
    "Kwa Vonza Cottage Hospital"
  ];

  // Login
  loginForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    loginError.textContent = "";
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    try {
      await signInWithEmailAndPassword(auth, email, password);
      loginForm.reset();
    } catch (err) {
      loginError.textContent = err.message;
    }
  });

  // Logout
  logoutBtn.addEventListener("click", async () => {
    await signOut(auth);
  });

  // Back button
  backBtn.addEventListener("click", () => {
    answersContainer.style.display = "none";
    dashboardContainer.style.display = "block";
  });

  // Auth state listener
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      loginContainer.style.display = "none";
      dashboardContainer.style.display = "block";
      await populateDashboardFromFirebase();
    } else {
      loginContainer.style.display = "block";
      dashboardContainer.style.display = "none";
      answersContainer.style.display = "none";
    }
  });

  async function populateDashboardFromFirebase() {
    try {
      const feedbackSnapshot = await getDocs(collection(db, "feedbacks"));
      const feedbacks = feedbackSnapshot.docs.map(doc => doc.data());
      const grouped = groupFeedbacks(feedbacks);
      dashboardBody.innerHTML = "";

      HOSPITALS.forEach(hospital => {
        const tr = document.createElement("tr");

        const tdName = document.createElement("td");
        tdName.textContent = hospital;
        tr.appendChild(tdName);

        const tdCount = document.createElement("td");
        tdCount.textContent = (grouped[hospital] || []).length;
        tr.appendChild(tdCount);

        const tdAction = document.createElement("td");
        const btn = document.createElement("button");
        btn.textContent = "View";
        btn.addEventListener("click", () => openAnswersFor(hospital, grouped[hospital] || []));
        tdAction.appendChild(btn);
        tr.appendChild(tdAction);

        dashboardBody.appendChild(tr);
      });

      noDataMessage.style.display = feedbacks.length === 0 ? "block" : "none";
    } catch (err) {
      console.error("Error fetching feedbacks:", err);
      dashboardBody.innerHTML = "<tr><td colspan='3'>Error loading feedbacks.</td></tr>";
    }
  }

  function groupFeedbacks(feedbacks) {
    const grouped = {};
    feedbacks.forEach(f => {
      const name = (f.hospitalName || "Unknown").toString().trim();
      if (!grouped[name]) grouped[name] = [];
      grouped[name].push(f);
    });
    return grouped;
  }

  function openAnswersFor(hospital, feedbacks) {
    dashboardContainer.style.display = "none";
    answersContainer.style.display = "block";
    answersTitle.textContent = "Answers — " + hospital;
    answersList.innerHTML = "";

    if (!feedbacks || feedbacks.length === 0) {
      const empty = document.createElement("div");
      empty.className = "empty";
      empty.textContent = "No answers yet for this hospital.";
      answersList.appendChild(empty);
      return;
    }

    feedbacks.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

    feedbacks.forEach(fb => {
      const div = document.createElement("div");
      div.className = "answer";

      let createdAtText = "n/a";
      if (fb.createdAt && fb.createdAt.seconds) {
        const date = new Date(fb.createdAt.seconds * 1000);
        createdAtText = date.toLocaleString();
      }

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = `${createdAtText} — ${fb.author || "anonymous"}`;
      div.appendChild(meta);

      const writtenContainer = document.createElement("div");
      writtenContainer.innerHTML = "<strong>Written Answers:</strong>";
      const choiceContainer = document.createElement("div");
      choiceContainer.innerHTML = "<strong>Selected Options:</strong>";

      let hasWritten = false, hasChoice = false;

      Object.keys(fb).forEach(key => {
        if (["createdAt", "hospitalName", "author"].includes(key)) return;
        const value = fb[key];

        if (Array.isArray(value) || (typeof value === "string" && value.includes(","))) {
          const p = document.createElement("div");
          const valText = Array.isArray(value) ? value.join(", ") : value;
          p.textContent = `${key.replace(/_/g," ")}: ${valText}`;
          choiceContainer.appendChild(p);
          hasChoice = true;
        } else if (typeof value === "string") {
          const p = document.createElement("div");
          p.textContent = `${key.replace(/_/g," ")}: ${value}`;
          writtenContainer.appendChild(p);
          hasWritten = true;
        }
      });

      if (hasWritten) div.appendChild(writtenContainer);
      if (hasChoice) div.appendChild(choiceContainer);

      answersList.appendChild(div);
    });
  }
});
</script>
</body>
</html>

