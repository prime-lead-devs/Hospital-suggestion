<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { 
  getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut 
} from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
import { 
  getFirestore, collection, onSnapshot, query, orderBy 
} from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDvVUrCLZj3Afu5MFqu5EhOGejyTfqEjgY",
  authDomain: "suggestion-box-4b869.firebaseapp.com",
  projectId: "suggestion-box-4b869",
  storageBucket: "suggestion-box-4b869.firebasestorage.app",
  messagingSenderId: "263926556991",
  appId: "1:263926556991:web:8c1f585f1f42fb72664b8a",
  measurementId: "G-RHHQJE2Y6B"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const loginContainer = document.getElementById("loginContainer");
const dashboardContainer = document.getElementById("dashboardContainer");
const answersContainer = document.getElementById("answersContainer");
const loginForm = document.getElementById("loginForm");
const loginError = document.getElementById("loginError");
const dashboardBody = document.getElementById("dashboardBody");
const logoutBtn = document.getElementById("logoutBtn");
const noDataMessage = document.getElementById("noDataMessage");
const answersTitle = document.getElementById("answersTitle");
const answersList = document.getElementById("answersList");
const backBtn = document.getElementById("backBtn");

const ALL_HOSPITALS = [
  "The Matuu Hospital",
  "Reliable Healthcare Services Hospital",
  "Ekalakala Nursing Home",
  "Ultrakathiani Hospital",
  "Ultrakathiani Hospital- Mitaboni",
  "Namanga Nursing Home",
  "Ginger Hospital",
  "Kwa Vonza Cottage Hospital"
];

/* ==================== LOGIN ==================== */
loginForm.addEventListener("submit", async e => {
  e.preventDefault();
  loginError.textContent = "";
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  try { await signInWithEmailAndPassword(auth, email, password); loginForm.reset(); }
  catch(err){ loginError.textContent = "Invalid credentials"; }
});

/* ==================== LOGOUT ==================== */
logoutBtn.addEventListener("click", async () => await signOut(auth));

/* ==================== BACK BUTTON ==================== */
backBtn.addEventListener("click", () => {
  answersContainer.style.display = "none";
  dashboardContainer.style.display = "block";
});

let feedbackListenerStarted = false;

onAuthStateChanged(auth, user => {
  if (user) {
    loginContainer.style.display = "none";
    dashboardContainer.style.display = "block";
    if (!feedbackListenerStarted) {
      listenToFeedbacks();
      feedbackListenerStarted = true;
    }
  } else {
    loginContainer.style.display = "block";
    dashboardContainer.style.display = "none";
    answersContainer.style.display = "none";
  }
});

/* ==================== REALTIME FEEDBACK LISTENER ==================== */
function listenToFeedbacks(){
  const q = query(collection(db, "hospitalFeedback"), orderBy("timestamp", "desc")); // FIXED COLLECTION & FIELD

  onSnapshot(q, snapshot => {
    const feedbacks = snapshot.docs.map(doc => doc.data());
    populateDashboard(feedbacks);
  });
}

/* ==================== POPULATE DASHBOARD ==================== */
function populateDashboard(feedbacks){
  const grouped = {};
  feedbacks.forEach(f => {
    const rawName = f.hospital || f.hospitalName || "";
    if (!rawName) return;
    const nameNorm = rawName.trim().toLowerCase();
    if (!grouped[nameNorm]) grouped[nameNorm] = [];
    grouped[nameNorm].push(f);
  });

  dashboardBody.innerHTML = "";

  ALL_HOSPITALS.forEach(realName => {
    const normName = realName.trim().toLowerCase();
    const feedbackList = grouped[normName] || [];

    const tr = document.createElement("tr");
    const tdName = document.createElement("td"); tdName.textContent = realName; tr.appendChild(tdName);

    const tdCount = document.createElement("td"); tdCount.textContent = feedbackList.length; tr.appendChild(tdCount);

    const tdAction = document.createElement("td");
    const btn = document.createElement("button");
    btn.textContent = "View";
    btn.disabled = feedbackList.length === 0;
    btn.addEventListener("click", () => openAnswers(realName, feedbackList));
    tdAction.appendChild(btn);
    tr.appendChild(tdAction);

    dashboardBody.appendChild(tr);
  });

  noDataMessage.style.display = feedbacks.length === 0 ? "block" : "none";
}

/* ==================== SHOW FEEDBACK ANSWERS ==================== */
function openAnswers(hospital, feedbacks){
  dashboardContainer.style.display = "none";
  answersContainer.style.display = "block";
  answersTitle.textContent = "Answers â€” " + hospital;
  answersList.innerHTML = "";

  if (!feedbacks || feedbacks.length === 0){
    const empty = document.createElement("div");
    empty.className = "empty";
    empty.textContent = "No answers yet for this hospital.";
    answersList.appendChild(empty);
    return;
  }

  feedbacks.forEach((fb, index) => {
    const respDiv = document.createElement("div");
    respDiv.className = "response";

    const header = document.createElement("div");
    header.className = "response-header";
    header.textContent = "Response #" + (index + 1);

    const content = document.createElement("div");
    content.className = "response-content";

    header.addEventListener("click", () => {
      content.style.display = content.style.display === "none" ? "block" : "none";
    });

    // Order of questions exactly like in HTML
    const QUESTION_KEYS = [
      "workDuration","employmentStatus","employmentOther",
      "workEnvironment","resourcesAvailable","deptCommunication","interDeptCommunication","feedbackValued",
      "supervisorApproach","managementCommunication","managementSupport","leadershipRating",
      "roleSatisfaction","workloadReasonable","skillsUtilized","careerOpportunities",
      "compensation","benefits","teamwork","fairness","motivation",
      "likes","improvements","suggestions",
      "signedContract","jobDescription","kpi","additionalServices"
    ];

    QUESTION_KEYS.forEach(key => {
      const val = fb[key] || "No response";
      const p = document.createElement("div");
      p.textContent = `${key}: ${val}`;
      content.appendChild(p);
    });

    respDiv.appendChild(header);
    respDiv.appendChild(content);
    answersList.appendChild(respDiv);
  });
}

</script>
