<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Manager Dashboard</title>
<style>
body { font-family: Arial, sans-serif; margin:20px; background:#f8f9fa; color:#111; }
h1 { color:#0a7b3f; text-align:center; }
.card { background:#fff; padding:20px; border-radius:10px; max-width:1000px; margin:20px auto; box-shadow:0 6px 20px rgba(0,0,0,0.06); }
table { width:100%; border-collapse:collapse; margin-top:20px; }
th, td { padding:10px; border:1px solid #ccc; text-align:left; }
th { background:#eee; }
button { padding:6px 10px; border:none; border-radius:5px; cursor:pointer; background:#0b5ed7; color:#fff; }
button:disabled { background:#ccc; cursor:not-allowed; }
#loginForm { max-width:400px; margin:50px auto; }
input { width:100%; padding:10px; margin:6px 0; border-radius:5px; border:1px solid #ccc; }
.logout { float:right; background:#d9534f; }
.small { font-size:0.9rem; color:#666; }
.answers-panel { margin-top:10px; }
.response { border:1px solid #ccc; border-radius:5px; margin-bottom:10px; padding:10px; background:#f9f9f9; }
.response-header { font-weight:bold; cursor:pointer; background:#e9ecef; padding:6px; border-radius:5px; }
.response-content { display:none; margin-top:6px; }
.meta { font-size:0.85rem; color:#666; margin-bottom:6px; }
.back { margin-top:12px; background:#6c757d; }
.empty { color:#666; padding:10px; }
.extra-field { font-style:italic; color:#444; margin-top:6px; }
</style>
</head>
<body>

<div id="loginContainer" class="card">
  <h1>Manager Login</h1>
  <form id="loginForm">
    <label class="small" for="email">Email</label>
    <input type="email" id="email" placeholder="Email" required>
    <label class="small" for="password">Password</label>
    <input type="password" id="password" placeholder="Password" required>
    <button type="submit">Login</button>
    <p id="loginError" style="color:red;"></p>
  </form>
</div>

<div id="dashboardContainer" class="card" style="display:none;">
  <h1>Manager Dashboard</h1>
  <button id="logoutBtn" class="logout">Logout</button>
  <table>
    <thead>
      <tr>
        <th>Hospital Name</th>
        <th>Total Feedbacks</th>
        <th>Feedbacks (View)</th>
      </tr>
    </thead>
    <tbody id="dashboardBody"></tbody>
  </table>
  <p id="noDataMessage" class="small" style="display:none;">No feedbacks found.</p>
</div>

<div id="answersContainer" class="card" style="display:none;">
  <h1 id="answersTitle">Answers</h1>
  <div id="answersList" class="answers-panel"></div>
  <div style="text-align:right;">
    <button id="backBtn" class="back">Back to Dashboard</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { 
  getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut 
} from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
import { 
  getFirestore, collection, onSnapshot, query, orderBy 
} from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

// ===== Firebase config =====
const firebaseConfig = {
  apiKey: "AIzaSyDvVUrCLZj3Afu5MFqu5EhOGejyTfqEjgY",
  authDomain: "suggestion-box-4b869.firebaseapp.com",
  projectId: "suggestion-box-4b869",
  storageBucket: "suggestion-box-4b869.firebasestorage.app",
  messagingSenderId: "263926556991",
  appId: "1:263926556991:web:8c1f585f1f42fb72664b8a",
  measurementId: "G-RHHQJE2Y6B"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ===== DOM elements =====
const loginContainer = document.getElementById("loginContainer");
const dashboardContainer = document.getElementById("dashboardContainer");
const answersContainer = document.getElementById("answersContainer");
const loginForm = document.getElementById("loginForm");
const loginError = document.getElementById("loginError");
const dashboardBody = document.getElementById("dashboardBody");
const logoutBtn = document.getElementById("logoutBtn");
const noDataMessage = document.getElementById("noDataMessage");
const answersTitle = document.getElementById("answersTitle");
const answersList = document.getElementById("answersList");
const backBtn = document.getElementById("backBtn");

// ===== All hospitals =====
const ALL_HOSPITALS = [
  "The Matuu Hospital",
  "Reliable Healthcare Services Hospital",
  "Ekalakala Nursing Home",
  "Ultrakathiani Hospital",
  "Ultrakathiani Hospital- Mitaboni",
  "Namanga Nursing Home",
  "Ginger Hospital",
  "Kwa Vonza Cottage Hospital"
];

// ===== Question order (keys must match what the form writes) =====
const QUESTION_ORDER = [
  { key: "A_q1", text: "How long have you worked with the company?" },
  { key: "A_q3", text: "What is your employment status?" },
  { key: "B_q1", text: "How would you rate your general work environment?" },
  { key: "B_q3", text: "Do you feel you have the tools and resources needed?" },
  { key: "B_q5", text: "How would you rate communication within your department?" },
  { key: "B_q7", text: "How would you rate communication between departments?" },
  { key: "B_q9", text: "Do you feel your ideas and feedback are valued by management?" },
  { key: "C_q1", text: "How approachable is your immediate supervisor/manager?" },
  { key: "C_q3", text: "How well does management communicate goals and expectations?" },
  { key: "C_q5", text: "Do you feel supported by management in your work and professional growth?" },
  { key: "C_q7", text: "How would you rate the overall leadership of the company?" },
  { key: "D_q1", text: "How satisfied are you with your current role?" },
  { key: "D_q3", text: "Do you believe your workload is reasonable?" },
  { key: "D_q5", text: "Are your skills and talents being fully utilized in your current position?" },
  { key: "D_q7", text: "Do you see opportunities for career growth and advancement?" },
  { key: "E_q1", text: "How satisfied are you with your compensation?" },
  { key: "E_q3", text: "How satisfied are you with employee benefits?" },
  { key: "F_q1", text: "How would you describe the teamwork in your department?" },
  { key: "F_q3", text: "Do you feel the company promotes fairness, respect, and equal opportunity?" },
  { key: "F_q5", text: "How motivated do you feel coming to work each day?" }
];

// ===== Login handler =====
loginForm.addEventListener("submit", async e => {
  e.preventDefault();
  loginError.textContent = "";
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  try {
    await signInWithEmailAndPassword(auth, email, password);
    loginForm.reset();
  } catch(err) {
    console.error("Login error:", err);
    loginError.textContent = err.message || "Login failed";
  }
});

// ===== Logout handler =====
logoutBtn.addEventListener("click", async () => {
  if (feedbackUnsubscribe) feedbackUnsubscribe(); // stop listener on logout
  await signOut(auth);
});

// ===== Back =====
backBtn.addEventListener("click", () => {
  answersContainer.style.display = "none";
  dashboardContainer.style.display = "block";
});

// ===== Auth + single listener protection =====
let feedbackListenerStarted = false;
let feedbackUnsubscribe = null;

onAuthStateChanged(auth, async user => {
  if (user) {
    loginContainer.style.display = "none";
    dashboardContainer.style.display = "block";

    if (!feedbackListenerStarted) {
      feedbackListenerStarted = true;
      listenToFeedbacks();
    }
  } else {
    loginContainer.style.display = "block";
    dashboardContainer.style.display = "none";
    answersContainer.style.display = "none";
  }
});

// ===== Firestore realtime listener (only once) =====
function listenToFeedbacks() {
  const q = query(collection(db, "feedbacks"), orderBy("createdAt", "desc"));
  feedbackUnsubscribe = onSnapshot(q, snapshot => {
    const feedbacks = snapshot.docs.map(doc => {
      const data = doc.data();
      // attach id for debugging if needed
      return { ...data, __id: doc.id };
    });
    populateDashboard(feedbacks);
  }, err => {
    console.error("onSnapshot error:", err);
  });
}

// ===== Populate dashboard =====
function normalizeName(name){
  if(!name) return "";
  return name.trim().toLowerCase();
}

function populateDashboard(feedbacks){
  const grouped = {};

  feedbacks.forEach(f => {
    // prefer hospitalName, fallback to hospital slug field
    const rawName = f.hospitalName || f.hospital || "";
    if(!rawName) return;
    const nameNorm = normalizeName(rawName);
    if(!grouped[nameNorm]) grouped[nameNorm] = [];
    grouped[nameNorm].push(f);
  });

  dashboardBody.innerHTML = "";

  ALL_HOSPITALS.forEach(displayName => {
    const normName = normalizeName(displayName);
    const list = grouped[normName] || [];

    const tr = document.createElement("tr");

    const tdName = document.createElement("td");
    tdName.textContent = displayName;
    tr.appendChild(tdName);

    const tdCount = document.createElement("td");
    tdCount.textContent = list.length;
    tr.appendChild(tdCount);

    const tdAction = document.createElement("td");
    const btn = document.createElement("button");
    btn.textContent = "View";
    btn.disabled = list.length === 0;
    btn.addEventListener("click", () => openAnswers(displayName, list));
    tdAction.appendChild(btn);
    tr.appendChild(tdAction);

    dashboardBody.appendChild(tr);
  });

  noDataMessage.style.display = feedbacks.length === 0 ? "block" : "none";
}

// ===== Show answers (preserve original layout) =====
function openAnswers(hospital, feedbacks){
  dashboardContainer.style.display = "none";
  answersContainer.style.display = "block";
  answersTitle.textContent = "Answers — " + hospital;
  answersList.innerHTML = "";

  if(!feedbacks || feedbacks.length === 0){
    const empty = document.createElement("div");
    empty.className = "empty";
    empty.textContent = "No answers yet for this hospital.";
    answersList.appendChild(empty);
    return;
  }

  feedbacks.forEach((fb, index) => {
    const respDiv = document.createElement("div");
    respDiv.className = "response";

    const content = document.createElement("div");
    content.className = "response-content";

    const header = document.createElement("div");
    header.className = "response-header";
    header.textContent = "Response #" + (index + 1);
    header.addEventListener("click", () => {
      content.style.display = content.style.display === "none" ? "block" : "none";
    });

    // Show ordered questions (use keys from QUESTION_ORDER)
    QUESTION_ORDER.forEach(q => {
      const answerRaw = fb[q.key];
      // treat empty string or undefined as "No response"
      const answer = (typeof answerRaw === "string" && answerRaw.trim() === "") || answerRaw === undefined
        ? "No response"
        : answerRaw;
      const p = document.createElement("div");
      p.textContent = `${q.text}: ${answer}`;
      content.appendChild(p);
    });

    // Show any extra fields saved in the document that are not in QUESTION_ORDER
    // We show fields that look like question keys (e.g., "A_q2_other", "G_q1", "X_q4")
    const knownKeys = new Set(QUESTION_ORDER.map(q => q.key).concat(["hospital","hospitalName","createdAt","__id"]));
    const extraKeys = Object.keys(fb).filter(k => !knownKeys.has(k)).sort();

    if(extraKeys.length > 0){
      const hr = document.createElement("div");
      hr.className = "meta";
      hr.textContent = "Other fields saved:";
      content.appendChild(hr);

      extraKeys.forEach(k => {
        // show even empty string so you can see it's empty
        const v = fb[k] === "" ? "(empty string)" : (fb[k] === undefined ? "(undefined)" : fb[k]);
        const d = document.createElement("div");
        d.className = "extra-field";
        d.textContent = `${k}: ${v}`;
        content.appendChild(d);
      });
    }

    // metadata (hospitalName, createdAt)
    const meta = document.createElement("div");
    meta.className = "meta";
    const created = fb.createdAt && fb.createdAt.toDate ? fb.createdAt.toDate().toLocaleString() : (fb.createdAt ? String(fb.createdAt) : "unknown");
    meta.textContent = `Hospital: ${fb.hospitalName || fb.hospital || "unknown"} • Submitted: ${created}`;
    content.appendChild(meta);

    respDiv.appendChild(header);
    respDiv.appendChild(content);
    answersList.appendChild(respDiv);
  });
}
</script>
</body>
</html>

